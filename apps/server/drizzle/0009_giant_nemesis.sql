DROP MATERIALIZED VIEW "finances"."account_monthly_stats";--> statement-breakpoint
CREATE MATERIALIZED VIEW "finances"."account_monthly_stats" WITH (autovacuum_enabled = true) AS (select "finances"."accounts"."id", "finances"."accounts"."userId", EXTRACT(YEAR FROM "finances"."transactions"."performedAt")::integer as "year", EXTRACT(MONTH FROM "finances"."transactions"."performedAt")::integer as "month", sum("finances"."transactions"."amount")::numeric as "monthlyBalance", SUM(CASE WHEN "finances"."transactions"."amount" > 0 THEN "finances"."transactions"."amount"::numeric ELSE 0 END) as "income", SUM(CASE WHEN "finances"."transactions"."amount" < 0 THEN abs("finances"."transactions"."amount")::numeric ELSE 0 END) as "outcome" from "finances"."accounts" inner join "finances"."transactions" on "finances"."transactions"."accountId" = "finances"."accounts"."id" group by "finances"."accounts"."id", "year", "month");