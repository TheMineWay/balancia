DROP MATERIALIZED VIEW "finances"."account_monthly_stats";--> statement-breakpoint
CREATE MATERIALIZED VIEW "finances"."account_monthly_stats" WITH (autovacuum_enabled = true) AS (select "finances"."accounts"."id", "finances"."accounts"."userId", date_trunc('month', "finances"."transactions"."performedAt")::timestamp as "date", sum("finances"."transactions"."amount")::numeric as "monthlyBalance", SUM(CASE WHEN "finances"."transactions"."amount" > 0 THEN "finances"."transactions"."amount" ELSE 0 END)::numeric as "income", SUM(CASE WHEN "finances"."transactions"."amount" < 0 THEN abs("finances"."transactions"."amount") ELSE 0 END)::numeric as "outcome" from "finances"."accounts" left join "finances"."transactions" on "finances"."transactions"."accountId" = "finances"."accounts"."id" group by "finances"."accounts"."id", "finances"."accounts"."userId", "date");
